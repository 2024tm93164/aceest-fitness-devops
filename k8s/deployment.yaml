# -----------------------------------------------------------
# Part 1: Kubernetes Deployment
# Manages the application pods, replicas, and Rolling Update strategy.
# -----------------------------------------------------------
apiVersion: apps/v1
kind: Deployment
metadata:
  name: aceest-fitness-deployment
  labels:
    app: aceest-fitness
spec:
  # RollingUpdate is the default strategy, enabling zero-downtime updates
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1          # Clean integer value
      maxUnavailable: 0    # Clean integer value - Requires all 3 replicas to be running before updating.
  
  replicas: 3 # Run 3 instances of the application for high availability
  selector:
    matchLabels:
      app: aceest-fitness
  template:
    metadata:
      labels:
        app: aceest-fitness
    spec:
      containers:
      - name: aceest-fitness
        # NOTE: It is recommended to use version tags (e.g., :v1.0.0) instead of :latest
        image: 26kishorekumar/aceest-fitness:latest 
        imagePullPolicy: Always 
        ports:
        - containerPort: 5000
        
        resources:
          limits:
            memory: "128Mi"
            cpu: "500m"
          requests:
            memory: "64Mi"
            cpu: "250m"

        # Liveness Probe: Checks if the container is still running and healthy
        livenessProbe:
          httpGet:
            path: /health
            port: 5000
          initialDelaySeconds: 15 # Increased delay to give the app time to start
          periodSeconds: 10
          timeoutSeconds: 3
          failureThreshold: 5   # Increased: Allows 5 failed checks before restart
        
        # Readiness Probe: Checks if the container is ready to serve traffic
        readinessProbe:
          httpGet:
            path: /health
            port: 5000
          initialDelaySeconds: 10 # Slightly longer delay
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 3 # Allows 3 failed checks before taking the pod out of service

      # --- NEW CRITICAL BLOCK ---
      imagePullSecrets:
      - name: docker-hub-regcred # Must match the secret name created in Jenkinsfile
      # --------------------------

---
# -----------------------------------------------------------
# Part 2: Kubernetes Service
# Exposes the Deployment to the network, necessary for Minikube access.
# -----------------------------------------------------------
apiVersion: v1
kind: Service
metadata:
  name: aceest-fitness-service
  labels:
    app: aceest-fitness # Added label for consistency
spec:
  # The Service targets pods with the label 'app: aceest-fitness'
  selector:
    app: aceest-fitness
  
  # NodePort is ideal for Minikube, exposing the service on a port on the host machine
  type: NodePort 
  ports:
    - protocol: TCP
      port: 5000      # The service port for internal cluster access
      targetPort: 5000 # The port your Flask app runs on (containerPort)
      nodePort: 30080 # Specific port on the node (30000-32767 range)